<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>TTS Stream Test</title></head>
<body>
<pre id="log"></pre>
<script>
var log = document.getElementById('log');
function L(msg) { log.textContent += msg + '\n'; console.log(msg); }

async function test() {
    // 1. Check ReadableStream body support
    L('--- Feature Detection ---');
    try {
        var s = new ReadableStream({start: function(c) { c.close(); }});
        new Request('https://example.com', {method: 'POST', body: s, duplex: 'half'});
        L('ReadableStream body + duplex:half = SUPPORTED');
    } catch(e) {
        L('ReadableStream body + duplex:half = NOT SUPPORTED: ' + e.message);
    }

    // 2. Check TextEncoderStream
    L('TextEncoderStream: ' + (typeof TextEncoderStream !== 'undefined' ? 'supported' : 'NOT supported'));

    // 3. Try actual streaming fetch
    L('\n--- Streaming Fetch Test ---');
    try {
        var controller;
        var textStream = new ReadableStream({
            start: function(c) { controller = c; }
        });
        var bodyStream = textStream.pipeThrough(new TextEncoderStream());

        L('bodyStream type: ' + Object.prototype.toString.call(bodyStream));
        L('bodyStream instanceof ReadableStream: ' + (bodyStream instanceof ReadableStream));

        // Enqueue a test sentence before fetch
        controller.enqueue('Hallo Welt.\n');
        controller.close();

        var resp = await fetch('https://srv.launix.de/tts/tts/stream?voice=de_DE-thorsten-medium', {
            method: 'POST',
            headers: {'Content-Type': 'text/plain'},
            duplex: 'half',
            body: bodyStream
        });
        L('HTTP status: ' + resp.status);
        L('Content-Type: ' + resp.headers.get('content-type'));

        var blob = await resp.blob();
        L('Response size: ' + blob.size + ' bytes');

        if (blob.size > 100) {
            var audio = new Audio(URL.createObjectURL(blob));
            audio.play();
            L('Playing audio...');
        }
    } catch(e) {
        L('FETCH ERROR: ' + e.name + ': ' + e.message);
    }
}

test();
</script>
</body>
</html>
